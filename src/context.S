
.attribute arch, "rv64gc"
.section ".data"

.align 8
kernel_context:
    .dword 0xFFFFFFFFFFFFFFFF

.align 8
thread_context:
    .dword 0xFFFFFFFFFFFFFFFF

.section ".text"

init_context:
    csrr a0, sstatus
    ori a0, a0, 0x20
    csrw sscratch, a0
    li a0, 0x20
    csrw sie, a0
    ret

activate_context:
    addi sp, sp, -496
    sd ra, 0(sp)
    sd gp, 8(sp)
    sd tp, 16(sp)
    sd t0, 24(sp)
    sd t1, 32(sp)
    sd t2, 40(sp)
    sd s0, 48(sp)
    sd s1, 56(sp)
    sd a0, 64(sp)
    sd a1, 72(sp)
    sd a2, 80(sp)
    sd a3, 88(sp)
    sd a4, 96(sp)
    sd a5, 104(sp)
    sd a6, 112(sp)
    sd a7, 120(sp)
    sd s2, 128(sp)
    sd s3, 136(sp)
    sd s4, 144(sp)
    sd s5, 152(sp)
    sd s6, 160(sp)
    sd s7, 168(sp)
    sd s8, 176(sp)
    sd s9, 184(sp)
    sd s10, 192(sp)
    sd s11, 200(sp)
    sd t3, 208(sp)
    sd t4, 216(sp)
    sd t5, 224(sp)
    sd t6, 232(sp)
    fsd ft0, 240(sp)
    fsd ft1, 248(sp)
    fsd ft2, 256(sp)
    fsd ft3, 264(sp)
    fsd ft4, 272(sp)
    fsd ft5, 280(sp)
    fsd ft6, 288(sp)
    fsd ft7, 296(sp)
    fsd fs0, 304(sp)
    fsd fs1, 312(sp)
    fsd fa0, 320(sp)
    fsd fa1, 328(sp)
    fsd fa2, 336(sp)
    fsd fa3, 344(sp)
    fsd fa4, 352(sp)
    fsd fa5, 360(sp)
    fsd fa6, 368(sp)
    fsd fa7, 376(sp)
    fsd fs2, 384(sp)
    fsd fs3, 392(sp)
    fsd fs4, 400(sp)
    fsd fs5, 408(sp)
    fsd fs6, 416(sp)
    fsd fs7, 424(sp)
    fsd fs8, 432(sp)
    fsd fs9, 440(sp)
    fsd fs10, 448(sp)
    fsd fs11, 456(sp)
    fsd ft8, 464(sp)
    fsd ft9, 472(sp)
    fsd ft10, 480(sp)
    fsd ft11, 488(sp)

    la t0, kernel_context
    sd sp, 0(t0)

    csrw sepc, a0

    la t0, thread_context
    sd a1, 0(t0)

    ld ra, 0(a1)
    ld sp, 8(a1)
    ld gp, 16(a1)
    ld tp, 24(a1)
    ld t0, 32(a1)
    ld t1, 40(a1)
    ld t2, 48(a1)
    ld s0, 56(a1)
    ld s1, 64(a1)
    ld a0, 72(a1)
    
    ld a2, 88(a1)
    ld a3, 96(a1)
    ld a4, 104(a1)
    ld a5, 112(a1)
    ld a6, 120(a1)
    ld a7, 128(a1)
    ld s2, 136(a1)
    ld s3, 144(a1)
    ld s4, 152(a1)
    ld s5, 160(a1)
    ld s6, 168(a1)
    ld s7, 176(a1)
    ld s8, 184(a1)
    ld s9, 192(a1)
    ld s10, 200(a1)
    ld s11, 208(a1)
    ld t3, 216(a1)
    ld t4, 224(a1)
    ld t5, 232(a1)
    ld t6, 240(a1)
    fld ft0, 248(a1)
    fld ft1, 256(a1)
    fld ft2, 264(a1)
    fld ft3, 272(a1)
    fld ft4, 280(a1)
    fld ft5, 288(a1)
    fld ft6, 296(a1)
    fld ft7, 304(a1)
    fld fs0, 312(a1)
    fld fs1, 320(a1)
    fld fa0, 328(a1)
    fld fa1, 336(a1)
    fld fa2, 344(a1)
    fld fa3, 352(a1)
    fld fa4, 360(a1)
    fld fa5, 368(a1)
    fld fa6, 376(a1)
    fld fa7, 384(a1)
    fld fs2, 392(a1)
    fld fs3, 400(a1)
    fld fs4, 408(a1)
    fld fs5, 416(a1)
    fld fs6, 424(a1)
    fld fs7, 432(a1)
    fld fs8, 440(a1)
    fld fs9, 448(a1)
    fld fs10, 456(a1)
    fld fs11, 464(a1)
    fld ft8, 472(a1)
    fld ft9, 480(a1)
    fld ft10, 488(a1)
    fld ft11, 496(a1) 

    ld a1, 80(a1)

    sret

.align 4
context_return:

    csrw sscratch, a1
    la a1, thread_context
    ld a1, 0(a1)

    sd ra, 0(a1)
    sd sp, 8(a1)
    sd gp, 16(a1)
    sd tp, 24(a1)
    sd t0, 32(a1)
    sd t1, 40(a1)
    sd t2, 48(a1)
    sd s0, 56(a1)
    sd s1, 64(a1)
    sd a0, 72(a1)

    sd a2, 88(a1)
    sd a3, 96(a1)
    sd a4, 104(a1)
    sd a5, 112(a1)
    sd a6, 120(a1)
    sd a7, 128(a1)
    sd s2, 136(a1)
    sd s3, 144(a1)
    sd s4, 152(a1)
    sd s5, 160(a1)
    sd s6, 168(a1)
    sd s7, 176(a1)
    sd s8, 184(a1)
    sd s9, 192(a1)
    sd s10, 200(a1)
    sd s11, 208(a1)
    sd t3, 216(a1)
    sd t4, 224(a1)
    sd t5, 232(a1)
    sd t6, 240(a1)
    fsd ft0, 248(a1)
    fsd ft1, 256(a1)
    fsd ft2, 264(a1)
    fsd ft3, 272(a1)
    fsd ft4, 280(a1)
    fsd ft5, 288(a1)
    fsd ft6, 296(a1)
    fsd ft7, 304(a1)
    fsd fs0, 312(a1)
    fsd fs1, 320(a1)
    fsd fa0, 328(a1)
    fsd fa1, 336(a1)
    fsd fa2, 344(a1)
    fsd fa3, 352(a1)
    fsd fa4, 360(a1)
    fsd fa5, 368(a1)
    fsd fa6, 376(a1)
    fsd fa7, 384(a1)
    fsd fs2, 392(a1)
    fsd fs3, 400(a1)
    fsd fs4, 408(a1)
    fsd fs5, 416(a1)
    fsd fs6, 424(a1)
    fsd fs7, 432(a1)
    fsd fs8, 440(a1)
    fsd fs9, 448(a1)
    fsd fs10, 456(a1)
    fsd fs11, 464(a1)
    fsd ft8, 472(a1)
    fsd ft9, 480(a1)
    fsd ft10, 488(a1)
    fsd ft11, 496(a1)

    csrr t0, sscratch
    sd t0, 80(a1)

    la t0, kernel_context
    ld sp, 0(t0)

    ld ra, 0(sp)
    ld gp, 8(sp)
    ld tp, 16(sp)
    ld t0, 24(sp)
    ld t1, 32(sp)
    ld t2, 40(sp)
    ld s0, 48(sp)
    ld s1, 56(sp)
    ld a0, 64(sp)
    ld a1, 72(sp)
    ld a2, 80(sp)
    ld a3, 88(sp)
    ld a4, 96(sp)
    ld a5, 104(sp)
    ld a6, 112(sp)
    ld a7, 120(sp)
    ld s2, 128(sp)
    ld s3, 136(sp)
    ld s4, 144(sp)
    ld s5, 152(sp)
    ld s6, 160(sp)
    ld s7, 168(sp)
    ld s8, 176(sp)
    ld s9, 184(sp)
    ld s10, 192(sp)
    ld s11, 200(sp)
    ld t3, 208(sp)
    ld t4, 216(sp)
    ld t5, 224(sp)
    ld t6, 232(sp)
    fld ft0, 240(sp)
    fld ft1, 248(sp)
    fld ft2, 256(sp)
    fld ft3, 264(sp)
    fld ft4, 272(sp)
    fld ft5, 280(sp)
    fld ft6, 288(sp)
    fld ft7, 296(sp)
    fld fs0, 304(sp)
    fld fs1, 312(sp)
    fld fa0, 320(sp)
    fld fa1, 328(sp)
    fld fa2, 336(sp)
    fld fa3, 344(sp)
    fld fa4, 352(sp)
    fld fa5, 360(sp)
    fld fa6, 368(sp)
    fld fa7, 376(sp)
    fld fs2, 384(sp)
    fld fs3, 392(sp)
    fld fs4, 400(sp)
    fld fs5, 408(sp)
    fld fs6, 416(sp)
    fld fs7, 424(sp)
    fld fs8, 432(sp)
    fld fs9, 440(sp)
    fld fs10, 448(sp)
    fld fs11, 456(sp)
    fld ft8, 464(sp)
    fld ft9, 472(sp)
    fld ft10, 480(sp)
    fld ft11, 488(sp)

    csrr a0, sepc
    csrr a1, scause

    addi sp, sp, 496
    ret

.global init_context
.global activate_context
.global context_return
